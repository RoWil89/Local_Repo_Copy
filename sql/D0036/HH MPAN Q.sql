
-- D0036 SETTLEMENT REPORTING
-- RETRIVES LATEST SETTLED VOLUME FOR ACTIVE IMPORT METERS


USE D0036;

-- SET AND DECLARE VARIABLES

DECLARE @SETDATE DATE
DECLARE @AGDATE DATE

SET @SETDATE = '2019.02.18'
SET @AGDATE =  '2019.03.07'

-- TEMP TABLE CHECK

IF OBJECT_ID('tempdb..#last_read') IS NOT NULL
DROP TABLE #last_read

IF OBJECT_ID('tempdb..#MC') IS NOT NULL
DROP TABLE #MC

--Create Temp MC Table

SELECT

 M1.J0003 AS 'MPAN'
,J0082 AS 'MC'

INTO #MC

FROM AFMSLocal.dbo.mpan M1

INNER JOIN 

(SELECT

  J0003
 ,MAX(J0049)AS 'MAX_REGI'

FROM AFMSLocal.dbo.mpan

GROUP BY J0003) M2

ON M1.J0003 = M2.J0003
AND M1.J0049 = M2.MAX_REGI


-- CREATE TEMP LAST READ TABLE (RELATIVE TO THE SETTLEMENT DATE)

SELECT DISTINCT 

   J0003
  ,MAX(FlowTstamp) AS 'Max_Read_Date'


into #last_read

FROM D0036.ZHV Z

LEFT JOIN D0036.D0036.G101 G1
ON Z.PK_ZHV = G1.FK_ZHV
LEFT JOIN D0036.D0036.G102 G2
ON G1.PK_101 = G2.FK_101
LEFT JOIN D0036.D0036.G103 G3
ON G2.PK_102 = G3.FK_102

WHERE J0073 = @SETDATE

AND J0103 = 'AI'

AND FlowTstamp < @AGDATE

GROUP BY J0003

-- RETURN DATA FOR MOST RECENT RECORD

SELECT DISTINCT

 G1.J0003 AS 'MPAN'
,@AGDATE AS 'Run Date'
,J0073 AS 'Settlement Date'
,J0020 as 'Consumption Type'
,#MC.MC AS 'Measurement Class'
,COUNT(J0020) 'Count of Consumption type'
,SUM(J0177) AS 'Metered Consumption'

FROM D0036.ZHV Z

LEFT JOIN D0036.D0036.G101 G1
ON 
Z.PK_ZHV = G1.FK_ZHV
LEFT JOIN D0036.D0036.G102 G2
ON
 G1.PK_101 = G2.FK_101
LEFT JOIN D0036.D0036.G103 G3
ON 
G2.PK_102 = G3.FK_102
INNER JOIN #last_read
ON
G1.J0003 = #last_read.J0003 AND
FlowTstamp = #last_read.Max_Read_Date
LEFT JOIN #MC
ON G1.J0003 = #MC.MPAN


WHERE J0103 = 'AI'

AND J0073 = @SETDATE

GROUP BY 
 G1.J0003
,J0073
,J0020
,MC

ORDER BY [Metered Consumption] desc