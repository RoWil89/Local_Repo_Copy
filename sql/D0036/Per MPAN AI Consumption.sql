
-- D0036 SETTLEMENT REPORTING
-- RETRIVES LATEST SETTLED VOLUME FOR ACTIVE IMPORT METERS


USE D0036;

-- SET AND DECLARE VARIABLES

DECLARE @SETDATE DATE
DECLARE @AGDATE DATE

SET @SETDATE = '2018.12.24'
SET @AGDATE =  '2019.01.15'

-- TEMP TABLE CHECK

IF OBJECT_ID('tempdb..#last_read') IS NOT NULL
	DROP TABLE #last_read

-- CREATE TEMP LAST READ TABLE (RELATIVE TO THE SETTLEMENT DATE)

SELECT DISTINCT 

	   J0003
	  ,MAX(FlowTstamp) AS 'Max_Read_Date'


into #last_read

FROM D0036.ZHV Z

LEFT JOIN D0036.D0036.G101 G1
ON Z.PK_ZHV = G1.FK_ZHV
LEFT JOIN D0036.D0036.G102 G2
ON G1.PK_101 = G2.FK_101
LEFT JOIN D0036.D0036.G103 G3
ON G2.PK_102 = G3.FK_102

WHERE J0073 = @SETDATE

AND J0103 = 'AI'

AND FlowTstamp < @AGDATE

GROUP BY J0003

-- RETURN DATA FOR MOST RECENT RECORD

SELECT DISTINCT

	 G1.J0003 AS 'MPAN'
	,J0073 AS 'Settlement Date'
	,J0020 as 'Consumption Type'
	,COUNT(J0020) 'Count of Consumption type'
	,SUM(J0177) AS 'Metered Consumption'

FROM D0036.ZHV Z

LEFT JOIN D0036.D0036.G101 G1
ON 
	Z.PK_ZHV = G1.FK_ZHV
LEFT JOIN D0036.D0036.G102 G2
ON
	 G1.PK_101 = G2.FK_101
LEFT JOIN D0036.D0036.G103 G3
ON 
	G2.PK_102 = G3.FK_102
INNER JOIN #last_read
ON
	G1.J0003 = #last_read.J0003 AND
	FlowTstamp = #last_read.Max_Read_Date

WHERE J0103 = 'AI'

AND J0073 = @SETDATE

GROUP BY 
	 G1.J0003
	,J0073
	,J0020

ORDER BY SUM(J0177) DESC